# ------------------------------------------------------------------------------
# íŒŒì¼: cmd.py
# ------------------------------------------------------------------------------
# ëª©ì :
# ADK ì±„íŒ… í´ë¼ì´ì–¸íŠ¸ì˜ ì§„ì…ì ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ Googleì˜ ADKë¥¼ ì‚¬ìš©í•˜ì—¬
# MCP ë„êµ¬ ì„œë²„ì— ì—°ê²°ëœ LLM agentì™€ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
# ------------------------------------------------------------------------------

import asyncio
import logging
from .client import MCPClient
from .utilities import print_json_response

# ------------------------------------------------------------------------------
# ì„¤ì • ìƒìˆ˜
# ------------------------------------------------------------------------------

# ADK ì•± ì‹ë³„ì (ì„¸ì…˜ì´ë‚˜ ë„êµ¬ë¥¼ ë“±ë¡í•  ë•Œ ì‚¬ìš©)
APP_NAME = "google_adk_gemini_mcp_client"

# í˜„ì¬ ì„¸ì…˜ì„ ìœ„í•œ ê³ ìœ  ì‚¬ìš©ì ID
USER_ID = "theailanguage_001"

# ê³ ìœ  ì„¸ì…˜ ID (ì—¬ëŸ¬ ì„¸ì…˜ì„ ì¬ê°œí•˜ê±°ë‚˜ êµ¬ë¶„í•˜ëŠ” ë° ë„ì›€ì´ ë¨)
SESSION_ID = "session_001"

# í´ë¼ì´ì–¸íŠ¸ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬ ì„¸íŠ¸ ì •ì˜
# ì´ë“¤ì€ í•˜ë‚˜ ì´ìƒì˜ ë„êµ¬ ì„œë²„ì—ì„œ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤
READ_ONLY_TOOLS = [
    'add_numbers',
    'subtract_numbers',
    'multiply_numbers',
    'divide_numbers',
    'run_command'
]

# ------------------------------------------------------------------------------
# ë¡œê¹… ì„¤ì •
# ------------------------------------------------------------------------------

# ERROR ë©”ì‹œì§€ë§Œ í‘œì‹œí•˜ë„ë¡ ë¡œê¹… êµ¬ì„± (INFO, DEBUG ë“± ì–µì œ)
logging.basicConfig(level=logging.ERROR)

# ------------------------------------------------------------------------------
# ë©”ì¸ ì±„íŒ… ë£¨í”„ í•¨ìˆ˜
# ------------------------------------------------------------------------------

async def chat_loop():
    """
    ì§€ì†ì ìœ¼ë¡œ ë‹¤ìŒì„ ìˆ˜í–‰í•˜ëŠ” ë©”ì¸ ì±„íŒ… ë£¨í”„:
    - ì‚¬ìš©ì ì…ë ¥ í”„ë¡¬í”„íŠ¸
    - ADK MCP agentì— ì…ë ¥ ì „ì†¡
    - agent ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë° ë° í‘œì‹œ
    """

    print("\nğŸ’¬ ADK LLM Agent ì±„íŒ…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì¢…ë£Œí•˜ë ¤ë©´ 'quit' ë˜ëŠ” ':q'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n")

    # ì•±/ì‚¬ìš©ì/ì„¸ì…˜ ì„¤ì •ìœ¼ë¡œ ADK MCP í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    client = MCPClient(
        app_name=APP_NAME,
        user_id=USER_ID,
        session_id=SESSION_ID,
        tool_filter=READ_ONLY_TOOLS
    )

    # ë„êµ¬ì„¸íŠ¸ì™€ ì„¸ì…˜ ì„¤ì • (MCP ë„êµ¬ ì„œë²„ì™€ í˜‘ìƒ)
    await client.init_session()

    try:
        # ì‚¬ìš©ì ì…ë ¥ì„ ë°›ê³  agent ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ì—°ì† ë£¨í”„
        while True:
            user_input = input("You: ")

            # ì¢…ë£Œ ëª…ë ¹ì„ ìš°ì•„í•˜ê²Œ ì²˜ë¦¬
            if user_input.strip().lower() in ["quit", ":q", "exit"]:
                print("ğŸ‘‹ ì„¸ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. ì•ˆë…•íˆ ê°€ì„¸ìš”!")
                break

            i = 0
            # ì…ë ¥ ì‘ì—…ì„ agentì— ë³´ë‚´ê³  ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë°
            async for event in await client.send_task(user_input):
                i += 1
                print_json_response(event, f"ğŸ“¦ ì´ë²¤íŠ¸ #{i}")

                # ìµœì¢… ì‘ë‹µì„ ë°›ìœ¼ë©´ ì¶œë ¥í•˜ê³  ë£¨í”„ ì¤‘ë‹¨
                if hasattr(event, "is_final_response") and event.is_final_response():
                    print(f"\nğŸ§  Agent ì‘ë‹µ:\n------------------------\n{event.content.parts[0].text}\n")
                    break
    finally:
        # ì„¸ì…˜ì´ ì¢…ë£Œë˜ê³  ë¦¬ì†ŒìŠ¤ê°€ í•´ì œë˜ë„ë¡ ë³´ì¥
        await client.shutdown()

# ------------------------------------------------------------------------------
# ì§„ì…ì 
# ------------------------------------------------------------------------------

if __name__ == '__main__':
    try:
        # asyncio ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸° ì±„íŒ… ë£¨í”„ ì‹œì‘
        asyncio.run(chat_loop())

    except asyncio.CancelledError:
        # ì´ ê²½ê³ ëŠ” ADK/MCPì˜ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì¢…ë£Œ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì¸í•´
        # ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë°ëª¨/êµìœ¡ìš© ì½”ë“œì—ì„œëŠ” ë¬´ì‹œí•´ë„ ì•ˆì „)
        print("\nâš ï¸ ì¢…ë£Œ ì¤‘ CancelledError ì–µì œë¨ "
        "(ë°ëª¨/êµìœ¡ìš© ì½”ë“œì—ì„œëŠ” ë¬´ì‹œí•´ë„ ì•ˆì „).")